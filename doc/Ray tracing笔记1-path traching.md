# 📚 **光线追踪递归与漫反射原理笔记**

## **1. 核心思想：路径追踪（Path Tracing）**
- 从**相机**（图像像素）发射光线。
- 光线在场景中**随机反射**（对漫反射表面）。
- 目标是让光线经过若干次弹跳后，**最终击中光源或明亮背景**。
- 通过大量随机路径的采样与平均，计算出每个像素的最终颜色。
- 这是一种**逆向的、基于蒙特卡洛积分**的物理模拟方法。所谓逆向就是应该是灯光在物体间不断的反射到相机从而相机得知反射后那个像素的颜色，而实际计算确实从相机发出的光线不断的在物体间弹射到灯光找到对应的灯光的颜色，再不断的顺着路径逆向计算颜色直到回到相机得到最终那个像素的颜色。

---

## **2. 递归函数 `ray_color` 的工作原理**

```cpp
color ray_color(const ray& r, int depth, const hittable& world)
```

### **递归终止条件**
```cpp
if (depth <= 0) return color(0, 0, 0); // 纯黑色
```
- 当光线弹跳次数用尽，不再贡献任何光能。

### **击中物体（漫反射）**
```cpp
if (world.hit(r, interval(0, infinity), rec)) {
    vec3 direction = random_on_hemisphere(rec.normal); // 半球内随机反射
    return 0.5 * ray_color(ray(rec.p, direction), depth-1, world);
}
```
- **行为**：在交点 `rec.p` 处，向法线半球内随机选择一个新方向。
- **能量衰减**：返回值乘以 `0.5`，模拟材质吸收 50% 光能，仅反射 50%。
- **递归**：沿新方向继续追踪，深度减 1。

### **未击中物体（背景/环境光）**
```cpp
vec3 unit_direction = unit_vector(r.direction());
auto a = 0.5*(unit_direction.y() + 1.0);
return (1.0-a)*white + a*blue; // 白色到淡蓝色的渐变
```
- 当光线未击中任何物体时，返回一个基于方向的**背景颜色**（如天空）。
- 这是整个递归过程中**唯一的非零颜色来源**。

---

### **3. 递归深度（Depth）的影响分析**

| 弹跳次数 (Depth) | 光线路径示例 | 返回颜色 | 说明 |
| :--- | :--- | :--- | :--- |
| **0** | 任意 | `(0,0,0)` | 深度用尽，无贡献 |
| **1** | `Camera → Object` | `(0,0,0)` | 反射后无光可带 |
| | `Camera → Sky` | `sky_color` | 直接看到背景 |
| **2** | `C → O1 → Sky` | `0.5 * sky_color` | 一次反射带回背景光，亮度减半 |
| | `C → O1 → O2` | `(0,0,0)` | 两次击中，无光带回 |
| **3** | `C → O1 → O2 → Sky` | `0.25 * sky_color` | 两次反射，亮度为背景的 1/4 |
| **n** | `C → O×(n-1) → Sky` | `sky_color × (0.5)^(n-1)` | 经过 `n-1` 次反射后看到背景 |

### **关键结论**
- ✅ **颜色的“源头”只有一个**：即背景（`sky_color`）或显式光源。
- ✅ **只有当某次弹跳后光线射向背景时，路径才有非零贡献**。
- ✅ **每次成功的漫反射都会将最终颜色乘以 0.5，造成亮度递减**。
- ✅ **即使 `depth` 很大（如 50），如果所有弹跳都击中物体而未看到背景，最终颜色仍是 `(0,0,0)`**。
- ✅ 实际渲染效果是**大量随机路径采样结果的平均值**，以减少噪点。

---

## **4. Path Tracing 与 Ray Tracing 的关系与对比**

### **核心关系**
> **Path Tracing 是 Ray Tracing 的一种具体实现方法。**
> - **所有 Path Tracing 都是 Ray Tracing**。
> - **但并非所有 Ray Tracing 都是 Path Tracing**。

可以理解为：**Ray Tracing 是“父类”，Path Tracing 是“子类”**。

### **详细对比**

| 特性 | **Ray Tracing (广义)** | **Path Tracing (特指)** |
| :--- | :--- | :--- |
| **定义** | 一大类通过追踪光线生成图像的技术 | Ray Tracing 中的一种**基于物理的、蒙特卡洛方法**的实现 |
| **范围** | **大类/总称**（如“交通工具”） | **子集/具体方法**（如“电动汽车”） |
| **核心方法** | 追踪光线路径，可确定或随机 | **必须使用随机采样**（蒙特卡洛） |
| **漫反射间接光** | 经典方法（如 Whitted）**无法处理** | ✅ **核心能力**，能自然模拟颜色溢出、全局光照 |
| **物理准确性** | 可高可低，取决于具体算法 | ✅ **非常高**，旨在求解渲染方程，接近真实 |
| **计算方式** | 可以是确定性的（如只追踪镜面反射） | ❌ **本质是随机的**（Stochastic），结果有噪点 |
| **输出结果** | 可能无噪点（路径确定） | 初始有噪点，需大量采样（spp）才能收敛平滑 |
| **典型应用** | 早期渲染、硬阴影、镜面反射、简单光线投射 | 现代电影级渲染、离线渲染器（Cycles, Arnold, RenderMan） |
| **递归深度作用** | 控制最大反射次数 | 控制路径最大长度，影响间接光阶数 |

### **通俗理解**
- **Ray Tracing** 是一个**宽泛的概念**，只要是“用光线来算颜色”的方法都可以叫光线追踪。
- **Path Tracing** 是 Ray Tracing 家族中**最先进的成员**，它用“**随机行走+统计平均**”的方式，解决了经典光线追踪无法处理的**漫反射全局光照**问题。

---

### **5. 漫反射光照的本质**

- **不是“接近”光源，而是“直接看到”光源或明亮环境**。
- 光线在漫反射表面的反射方向是**随机的**，没有明确目标。
- 能否“找到”光源完全依赖**随机采样和统计概率**。
- 多次弹跳后仍能带回光的路径较少，因此间接光照通常较暗。
- `0.5` 的乘数是一种**简化的、非物理的衰减模型**。真实渲染中会使用基于 BRDF 和采样概率的更精确权重。

---

### **6. 总结：像素颜色是如何形成的？**

一个像素的最终颜色，是以下过程的统计结果：

1. 从该像素发射多条光线。
2. 每条光线在场景中随机弹跳。
3. **只有那些最终击中光源或明亮背景的路径**，才会为颜色做贡献。
4. 每条有效路径的贡献 = `光源颜色 × (0.5)^k`，其中 `k` 是弹跳次数。
5. 将所有路径的贡献**累加并平均**，得到平滑的像素颜色。